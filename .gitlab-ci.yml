workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

stages:
 # - sonar-scan
  - build
  - deploy
  
sonarqube-check:
  stage: sonar-scan
  tags:
#    - docker
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  allow_failure: true

# test-code-job2:
#   stage: deploy
#   image: alpine/helm:3.9.1
#   script:
#     - ls -la
#     - helm repo add jhidalgo3-github https://jhidalgo3.github.io/helm-charts/
#     - helm upgrade --install my-hello-kubernetes-chart jhidalgo3-github/hello-kubernetes-chart --version 3.0.0 -n hello-test

# test-code-job3:
#   stage: deploy
#   image: alpine/helm:3.9.1
#   script:
#     - cd helmcharts
#     - helm upgrade --install mydemochart mydemo -n test2

deploy-wagtail:
  stage: deploy
  image: alpine/helm:3.9.1
  script:
    - cd helmcharts
    - helm upgrade --install wagtail-chart app_helmChart -n dev

# health-wagtail:
#   stage: test
#   image: wbitt/network-multitool
#   script:
#     - nslookup wagtail.prtest.tech
       

#include: 'myapp/.buildapp-ci.yml'
#include: 'backup/.build-image-ci.yml'
include: 'application/mysite/.build-wagtail.yml'
